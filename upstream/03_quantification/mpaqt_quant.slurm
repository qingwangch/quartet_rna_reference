#!/bin/bash
#SBATCH --job-name=mpaqt_quant
#SBATCH --partition=regular               # Use the regular partition
#SBATCH --mem=32G
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --time=24:00:00
#SBATCH --output=logs/mpaqt_quant_%j.log
#SBATCH --error=logs/mpaqt_quant_%j.log

set -eo pipefail

# Load Singularity module
module load singularity

# ------------------------ Parse arguments ------------------------ #
while [[ "$#" -gt 0 ]]; do
  case $1 in
    --project) project="$2"; shift ;;
    --sample) sample="$2"; shift ;;
    *) echo "âŒ Unknown parameter passed: $1"; exit 1 ;;
  esac
  shift
done

if [[ -z "$project" || -z "$sample" ]]; then
  echo "Usage: sbatch $0 --project <project_name> --sample <sample_id>"
  exit 1
fi

# ------------------------ Setup ------------------------ #
# å®šä¹‰é•œåƒç›®å½•å’Œ MPAQT æ ¹ç›®å½•ï¼ˆè¯·æ ¹æ®å®é™…è·¯å¾„ä¿®æ”¹ï¼‰
imgDIR=/vast/projects/quartet_rna_refdata/images
mpaqt_root=/vast/projects/quartet_rna_refdata/analysis/mpaqt

start_time=$(date +%s)
echo "ğŸš€ [$sample] Quantification starts at: $(date)"
echo "ğŸ“ Project: $project"
echo "ğŸ§ª Sample: $sample"

# ------------------------ Run MPAQT quant ------------------------ #
# ç»‘å®šç›®å½•ï¼š
#   - $mpaqt_root ç»‘å®šåˆ°å®¹å™¨å†… /csglab ä»¥ä¿è¯å®¹å™¨èƒ½è®¿é—® MPAQT ç›¸å…³æ•°æ®
#   - /vast/projects/quartet_rna_refdata æŒ‚è½½ï¼Œä½¿å®¹å™¨èƒ½è®¿é—®å‚è€ƒæ•°æ®å’Œå…¶å®ƒå¿…éœ€æ–‡ä»¶
singularity exec --bind $mpaqt_root/projects:/csglab/mpaqt/projects, \
                   --bind $mpaqt_root/tmpdir:/csglab/mpaqt/tmp, \
                   --bind /vast/projects/quartet_rna_refdata:/vast/projects/quartet_rna_refdata \
  $imgDIR/mpaqt_0.3.1.sif /csglab/mpaqt/mpaqt quant \
    --project "$project" \
    --sample "$sample"

echo "âœ… mpaqt quantification complete for $sample"

# ------------------------ Wrap-up ------------------------ #
end_time=$(date +%s)
duration=$((end_time - start_time))
echo "â° [$sample] Finished at: $(date)"
echo "ğŸ•’ Total runtime: ${duration} seconds"
